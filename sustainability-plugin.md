# Sustainability plugin

The sustainability plugin uses a number of tools/software to estimate the carbon emissions of your running workloads across the whole stack (hardware, embedded emissions, energy consumption).

For calculating the energy consumed by the workloads we use [Kepler](https://sustainable-computing.io/). Therefore, Kepler needs to be installed.

## Step 1: install Kepler

For Kepler to run you need to have Prometheus and Grafana installed. After that you can install Kepler as described in their [documentation](https://sustainable-computing.io/installation/kepler-helm/)):


### Install Kepler manually using Helm

```bash
# First a dry run to see what is going to happen:
helm install kepler kepler/kepler --namespace monitoring --dry-run --devel

# Effectively install it:
helm install kepler kepler/kepler --namespace monitoring
```

In this case I chose `monitoring` as namespace because our Prometheus installation is only pulling data from this namespace, but you can also install in `kepler` namespace or another one.


### Install Kepler with ArgoCD and Helm

Alternatively, if you are using ArgoCD, here's an example yaml to install it:

```yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: kepler
  namespace: argocd
spec:
  generators:
    - clusters:
        selector:
          matchLabels:
            clusterType: "host"
  template:
    metadata:
      name: '{{name}}--kepler'
    spec:
      project: default
      source:
        repoURL: 'https://sustainable-computing-io.github.io/kepler-helm-chart'
        targetRevision: 0.5.6
        helm:
          values: |-
            serviceMonitor:
              enabled: true
              labels:
                # The name we gave to the Prometheus stack when installing it:
                release: kube-prometheus-stack
            extraEnvVars:
              # Here we remove some metrics that we don't need
              # for sustainability and clarity purposes
              # (TODO: it seems it's not working, it keeps gathering all the metrics
              # and doesn't get these environment variables in the pod, but for later)
              EXPOSE_HW_COUNTER_METRICS: "false"
              EXPOSE_IRQ_COUNTER_METRICS: "false"
              EXPOSE_CGROUP_METRICS: "false"
          chart: kepler
      destination:
        server: '{{server}}'
        namespace: monitoring
      syncPolicy:
        automated:
          prune: true
          allowEmpty: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
          - ApplyOutOfSyncOnly=true
```

In this case we chose to install Kepler in `monitoring` namespace because our Prometheus installation picks up data from the `monitoring` namespace, but you can pick another namespace as long as Prometheus operator picks it up.


### Test that Kepler is working

You can check that data is generated by Kepler by forwarding the service and checking the `/metrics` url as follows:

```bash
kubectl port-forward service/kepler 9102:9102 -n monitoring &
curl http://localhost:9102/metrics
```

And then you can go to Prometheus and check that the data is being picked up by Prometheus. As you can see, all the data generated starts with `kepler_`.

So you can go to Prometheus (port-forward the Prometheus service and access the Prometheus dashboard) and look for any metrics which start with `kepler_`.

### Is Kepler using RAPL?

If your hardware has RAPL enabled, you might want to verify that Kepler is using it.

You can look at the metrics. If they are coming from RAPL hardware you will see it in the `source` property, with value `intel_rapl` property:

```
# HELP kepler_container_core_joules_total Aggregated value in core value from intel_rapl
# TYPE kepler_container_core_joules_total counter
kepler_container_core_joules_total{container_id="01e814d17335d7d9cbcf7a9dfdfbe44ed57b947db0bcf68332bd411c4a59c838",container_name="konnectivity-server",container_namespace="tenant-tenant1",mode="dynamic",pod_name="tenant1-control-plane-6974c77f55-w2qhz",source="intel_rapl"} 0
kepler_container_core_joules_total{container_id="01e814d17335d7d9cbcf7a9dfdfbe44ed57b947db0bcf68332bd411c4a59c838",container_name="konnectivity-server",container_namespace="tenant-tenant1",mode="idle",pod_name="tenant1-control-plane-6974c77f55-w2qhz",source="intel_rapl"} 0
kepler_container_core_joules_total{container_id="0a8814deec04d41de512a0b8672c473ecc7ce40cd3c304d830945903783796f4",container_name="frontend",container_namespace="kube-system",mode="dynamic",pod_name="hubble-ui-6b468cff75-cnnd5",source="intel_rapl"} 0
kepler_container_core_joules_total{container_id="0a8814deec04d41de512a0b8672c473ecc7ce40cd3c304d830945903783796f4",container_name="frontend",container_namespace="kube-system",mode="idle",pod_name="hubble-ui-6b468cff75-cnnd5",source="intel_rapl"} 0
kepler_container_core_joules_total{container_id="0d5bc2dff5d1ad7b1a787ecc485cf658c5575f607402ff43e13a0715fba013f8",container_name="node-exporter",container_namespace="monitoring",mode="dynamic",pod_name="kube-prometheus-stack-prometheus-node-exporter-pk8nj",source="intel_rapl"} 839.214
kepler_container_core_joules_total{container_id="0d5bc2dff5d1ad7b1a787ecc485cf658c5575f607402ff43e13a0715fba013f8",container_name="node-exporter",container_namespace="monitoring",mode="idle",pod_name="kube-prometheus-stack-prometheus-node-exporter-pk8nj",source="intel_rapl"} 9095.976
```

If they come from the server model, on the other hand, you will see the `source` property with value `bpf`:

```
# HELP kepler_container_core_joules_total Aggregated value in core value from trained_power_model
# TYPE kepler_container_core_joules_total counter
kepler_container_core_joules_total{container_id="05376236d48bda56c73e96812212f0860471bdba724de74acea0cac4a321d993",container_name="kube-rbac-proxy-main",container_namespace="monitoring",mode="dynamic",pod_name="kube-state-metrics-764c45b976-l9pdq",source="trained_power_model"} 0
kepler_container_core_joules_total{container_id="0d11c14bffe8f2a83cc82aa7f138f0c2640415266de70845eeaa9117073c3bfe",container_name="config-reloader",container_namespace="monitoring",mode="dynamic",pod_name="prometheus-k8s-0",source="trained_power_model"} 0
kepler_container_core_joules_total{container_id="1e2e21cf458a8ab3154459f25d12f6943c8d1d435fc489ccbaece00e967b6fe3",container_name="kube-rbac-proxy",container_namespace="monitoring",mode="dynamic",pod_name="prometheus-operator-856d79c475-xlxcr",source="trained_power_model"} 0
```

You can check the Kepler logs like this:

```bash
kubectl -n monitoring logs ds/kepler
```

I see the following, even though the metrics are indeed coming from RAPL as seen in the metrics, so I suppose we can ignore this :):

```console
I0506 12:43:17.544898       1 process_energy.go:114] Using the Ratio/DynPower Power Model to estimate Process Platform Power
```






